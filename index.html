<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Peminjaman Buku Perpustakaan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Menambahkan animate.css untuk animasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e6e9ff;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        /* Header Styles */
        .app-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        
        .app-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        
        .app-subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
            position: relative;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background-color: var(--secondary-color);
            border-bottom: none;
            padding: 0;
            position: relative;
            z-index: 1;
        }
        
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 0;
            padding: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .nav-tabs .nav-link::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background-color: white;
            transform: translateX(-50%);
            transition: var(--transition);
        }
        
        .nav-tabs .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs .nav-link:hover::before {
            width: 100%;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .nav-tabs .nav-link.active::before {
            width: 100%;
            background-color: white;
        }
        
        /* Card Styles */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--light-color);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1rem 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card {
            border-left: 4px solid var(--primary-color);
        }
        
        /* Form Styles */
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-control, .form-select {
            padding: 0.6rem 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        /* Button Styles */
        .btn {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Table Styles */
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
            position: sticky;
            top: 0;
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--primary-light);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 35px;
            border-radius: 50px !important;
        }
        
        /* Invoice Styles */
        .invoice {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-top: 1.5rem;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background-color: var(--primary-color);
            color: white;
        }
        
        .invoice-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .invoice-meta p {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal-content {
            border: none;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        /* Toast Notification */
        .toast {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--box-shadow);
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .app-title {
                font-size: 1.5rem;
            }
            
            .nav-tabs .nav-link {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .invoice-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .invoice-meta {
                text-align: center;
            }
        }
        
        @media (max-width: 576px) {
            .app-title {
                font-size: 1.3rem;
            }
            
            .nav-tabs .nav-link {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Animations */
        .animate-bounce {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Autocomplete */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: white;
            border-bottom: 1px solid #ddd;
        }
        
        .autocomplete-items div:hover {
            background-color: var(--primary-light);
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container animate__animated animate__fadeIn">
        <header class="app-header">
            <h1 class="app-title">
                <i class="fas fa-book-open animate__animated animate__bounceIn"></i>
                Sistem Peminjaman Buku Perpustakaan
            </h1>
            <p class="app-subtitle">Manajemen peminjaman buku dengan perhitungan denda otomatis</p>
        </header>
        
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="peminjaman-tab" data-bs-toggle="tab" data-bs-target="#peminjaman" type="button" role="tab">
                    <i class="fas fa-book-reader"></i> Peminjaman
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pengembalian-tab" data-bs-toggle="tab" data-bs-target="#pengembalian" type="button" role="tab">
                    <i class="fas fa-book-open"></i> Pengembalian
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="riwayat-tab" data-bs-toggle="tab" data-bs-target="#riwayat" type="button" role="tab">
                    <i class="fas fa-history"></i> Riwayat
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="laporan-tab" data-bs-toggle="tab" data-bs-target="#laporan" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> Laporan
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabsContent">
            <!-- Tab Peminjaman -->
            <div class="tab-pane fade show active" id="peminjaman" role="tabpanel">
                <div class="card info-card animate__animated animate__fadeIn">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Ketentuan Peminjaman
                    </div>
                    <div class="card-body">
                        <div class="alert alert-primary d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <div>
                                <strong>Perhatian!</strong> Pastikan data yang dimasukkan sudah benar sebelum menyimpan.
                            </div>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Peminjaman buku dilakukan per minggu
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                <strong>Denda keterlambatan: Rp5.000 per hari</strong> (termasuk weekend)
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-calculator text-primary me-2"></i>
                                Perhitungan denda dimulai dari hari setelah jatuh tempo
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-file-invoice text-info me-2"></i>
                                Invoice otomatis dibuat untuk pembayaran denda
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="card animate__animated animate__fadeInUp">
                    <div class="card-header">
                        <i class="fas fa-edit"></i> Form Peminjaman Buku
                    </div>
                    <div class="card-body">
                        <form id="formPeminjaman">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="namaPeminjam" class="form-label">
                                        <i class="fas fa-user"></i> Nama Peminjam <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="namaPeminjam" required placeholder="Masukkan nama lengkap">
                                    <div class="invalid-feedback">Harap isi nama peminjam</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="noHp" class="form-label">
                                        <i class="fas fa-phone"></i> No. HP <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="noHp" required placeholder="081234567890" pattern="[0-9]{10,13}">
                                    <div class="invalid-feedback">Harap isi nomor HP yang valid (10-13 digit)</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope"></i> Email (opsional)
                                    </label>
                                    <input type="email" class="form-control" id="email" placeholder="email@contoh.com">
                                    <div class="invalid-feedback">Format email tidak valid</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="judulBuku" class="form-label">
                                        <i class="fas fa-book"></i> Judul Buku <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="judulBuku" required placeholder="Judul buku yang dipinjam">
                                    <div class="invalid-feedback">Harap isi judul buku</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="kodeBuku" class="form-label">
                                        <i class="fas fa-barcode"></i> Kode Buku <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="kodeBuku" required placeholder="Kode unik buku">
                                    <div class="invalid-feedback">Harap isi kode buku</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tanggalPinjam" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Tanggal Pinjam <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="tanggalPinjam" required>
                                    <div class="invalid-feedback">Harap pilih tanggal pinjam</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="lamaPinjam" class="form-label">
                                        <i class="fas fa-clock"></i> Lama Pinjam (minggu) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="lamaPinjam" min="1" value="1" required>
                                    <div class="invalid-feedback">Harap isi lama pinjam (minimal 1 minggu)</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-check"></i> Jatuh Tempo
                                    </label>
                                    <input type="text" class="form-control" id="jatuhTempo" readonly placeholder="Akan dihitung otomatis">
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" id="btnSimpan">
                                    <i class="fas fa-save"></i> Simpan Peminjaman
                                </button>
                                <button type="reset" class="btn btn-outline-primary">
                                    <i class="fas fa-undo"></i> Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Tab Pengembalian -->
            <div class="tab-pane fade" id="pengembalian" role="tabpanel">
                <div class="card animate__animated animate__fadeIn">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exchange-alt"></i> Proses Pengembalian Buku
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="btnRefreshPengembalian">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="searchPeminjaman" placeholder="Cari berdasarkan nama, judul buku, atau kode...">
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelPengembalian">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Nama Peminjam</th>
                                        <th>Judul Buku</th>
                                        <th>Kode Buku</th>
                                        <th>Tanggal Pinjam</th>
                                        <th>Jatuh Tempo</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pengembalianBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Memuat data peminjaman...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Invoice Section -->
                <div class="invoice" id="invoiceSection" style="display: none;">
                    <div class="invoice-header">
                        <div class="invoice-logo">
                            <i class="fas fa-book-open fa-3x"></i>
                            <div>
                                <h1 class="invoice-title">Perpustakaan XYZ</h1>
                                <p>Jl. Perpustakaan No. 123, Kota</p>
                                <p>Telp: (021) 12345678 | Email: perpus@xyz.com</p>
                            </div>
                        </div>
                        <div class="invoice-meta">
                            <h5>INVOICE DENDA</h5>
                            <p><strong>No. Invoice:</strong> <span id="invoiceNumber">INV-2023-001</span></p>
                            <p><strong>Tanggal:</strong> <span id="invoiceDate">01 Jan 2023</span></p>
                            <p><strong>Status:</strong> <span class="badge bg-success">LUNAS</span></p>
                        </div>
                    </div>
                    
                    <div class="invoice-body">
                        <div class="invoice-details">
                            <div class="invoice-section">
                                <h5>Detail Peminjam</h5>
                                <div class="invoice-row">
                                    <span class="invoice-label">Nama:</span>
                                    <span id="invoiceNama">-</span>
                                </div>
                                <div class="invoice-row">
                                    <span class="invoice-label">No. HP:</span>
                                    <span id="invoiceHp">-</span>
                                </div>
                                <div class="invoice-row">
                                    <span class="invoice-label">Email:</span>
                                    <span id="invoiceEmail">-</span>
                                </div>
                            </div>
                            
                            <div class="invoice-section">
                                <h5>Detail Buku</h5>
                                <div class="invoice-row">
                                    <span class="invoice-label">Judul:</span>
                                    <span id="invoiceJudul">-</span>
                                </div>
                                <div class="invoice-row">
                                    <span class="invoice-label">Kode:</span>
                                    <span id="invoiceKode">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3">
                            <i class="fas fa-clock"></i> Detail Keterlambatan
                        </h5>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <p class="mb-1 text-muted">Tanggal Pinjam</p>
                                        <h5 class="mb-0" id="detailPinjam">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <p class="mb-1 text-muted">Jatuh Tempo</p>
                                        <h5 class="mb-0" id="detailTempo">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <p class="mb-1 text-muted">Dikembalikan</p>
                                        <h5 class="mb-0" id="detailKembali">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <p class="mb-1 text-muted">Keterlambatan</p>
                                        <h5 class="mb-0 text-danger" id="detailTelat">-</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Deskripsi</th>
                                    <th>Jumlah Hari</th>
                                    <th>Tarif Denda</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total Denda:</strong></td>
                                    <td class="text-danger fw-bold" id="invoiceTotal">Rp0</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <h5 class="mt-4 mb-3">
                            <i class="fas fa-money-bill-wave"></i> Metode Pembayaran
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-university fa-2x mb-3 text-primary"></i>
                                        <h5>Transfer Bank</h5>
                                        <p class="text-muted">BCA 1234567890 a.n. Perpustakaan XYZ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-money-bill-alt fa-2x mb-3 text-primary"></i>
                                        <h5>Tunai</h5>
                                        <p class="text-muted">Di kantor perpustakaan</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Catatan:</strong> Pembayaran denda harus dilakukan maksimal 7 hari setelah pengembalian buku.
                        </div>
                    </div>
                    
                    <div class="invoice-footer">
                        <p class="mb-0 text-muted">
                            <i class="fas fa-info-circle"></i> Harap simpan invoice ini sebagai bukti pembayaran
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" id="btnPrintInvoice">
                                <i class="fas fa-print"></i> Cetak Invoice
                            </button>
                            <button class="btn btn-outline-primary" id="btnCloseInvoice">
                                <i class="fas fa-times"></i> Tutup
                            </button>
                            <button class="btn btn-success" id="btnConfirmPayment">
                                <i class="fas fa-check-circle"></i> Konfirmasi Pembayaran
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Riwayat -->
            <div class="tab-pane fade" id="riwayat" role="tabpanel">
                <div class="card animate__animated animate__fadeIn">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-history"></i> Riwayat Peminjaman
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="btnExportRiwayat">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="btnRefreshRiwayat">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="searchRiwayat" placeholder="Cari riwayat...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="date" class="form-control" id="filterDari">
                                    </div>
                                    <div class="col">
                                        <input type="date" class="form-control" id="filterSampai">
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-primary" id="btnFilter">
                                            <i class="fas fa-filter"></i> Filter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelRiwayat">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Nama Peminjam</th>
                                        <th>Judul Buku</th>
                                        <th>Kode Buku</th>
                                        <th>Tanggal Pinjam</th>
                                        <th>Jatuh Tempo</th>
                                        <th>Pengembalian</th>
                                        <th>Keterlambatan</th>
                                        <th>Denda</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="riwayatBody">
                                    <tr>
                                        <td colspan="10" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Memuat data riwayat...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex gap-3">
                                <p class="mb-0">Total Data: <strong id="totalData">0</strong></p>
                                <p class="mb-0">Total Denda: <strong id="totalDenda">Rp0</strong></p>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-outline-primary btn-sm" id="btnPrev">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="pageInfo">Halaman 1 dari 1</span>
                                <button class="btn btn-outline-primary btn-sm" id="btnNext">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Laporan -->
            <div class="tab-pane fade" id="laporan" role="tabpanel">
                <div class="card animate__animated animate__fadeIn">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-pie"></i> Laporan Peminjaman
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="btnRefreshLaporan">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Jenis Laporan</label>
                                <select class="form-select" id="reportType">
                                    <option value="mingguan">Mingguan</option>
                                    <option value="bulanan">Bulanan</option>
                                    <option value="tahunan">Tahunan</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="dateRangeControls">
                                <label class="form-label">Pilih Minggu</label>
                                <input type="week" class="form-control" id="reportDate">
                            </div>
                            <div class="col-md-4 d-flex align-items-end gap-2">
                                <button class="btn btn-primary" id="btnGenerateReport">
                                    <i class="fas fa-sync-alt"></i> Generate
                                </button>
                                <button class="btn btn-outline-primary" id="btnExportReport">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-book mb-2 text-primary"></i>
                                        <p class="mb-1 text-muted">Total Peminjaman</p>
                                        <h3 class="mb-0" id="totalPeminjaman">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-check-circle mb-2 text-success"></i>
                                        <p class="mb-1 text-muted">Tepat Waktu</p>
                                        <h3 class="mb-0" id="tepatWaktu">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-exclamation-triangle mb-2 text-warning"></i>
                                        <p class="mb-1 text-muted">Terlambat</p>
                                        <h3 class="mb-0" id="terlambat">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-money-bill-wave mb-2 text-danger"></i>
                                        <p class="mb-1 text-muted">Total Denda</p>
                                        <h3 class="mb-0" id="reportDenda">Rp0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4" style="height: 300px;">
                            <canvas id="reportChart"></canvas>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="reportTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Tanggal</th>
                                        <th>Jumlah Peminjaman</th>
                                        <th>Pengembalian Tepat Waktu</th>
                                        <th>Keterlambatan</th>
                                        <th>Total Denda</th>
                                    </tr>
                                </thead>
                                <tbody id="reportBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Pengembalian -->
    <div class="modal fade" id="pengembalianModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-book-open"></i> Pengembalian Buku
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalContent">
                        <!-- Konten akan diisi oleh JavaScript -->
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalTanggalKembali" class="form-label">
                            <i class="fas fa-calendar-check"></i> Tanggal Kembali
                        </label>
                        <input type="date" class="form-control" id="modalTanggalKembali">
                    </div>
                    
                    <div class="card d-none" id="dendaPreview">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-calculator"></i> Perkiraan Denda
                            </h5>
                            <div class="row">
                                <div class="col">
                                    <p class="mb-1 text-muted">Keterlambatan</p>
                                    <h5 class="mb-0" id="previewTelat">0 hari</h5>
                                </div>
                                <div class="col">
                                    <p class="mb-1 text-muted">Total Denda</p>
                                    <h5 class="mb-0 text-danger" id="previewDenda">Rp0</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnProsesPengembalian">
                        <i class="fas fa-check"></i> Konfirmasi Pengembalian
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Apakah Anda yakin ingin melanjutkan?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifikasi -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <small id="toastTime">Baru saja</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Pesan notifikasi akan muncul di sini
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 left-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 1200; display: none;">
        <div class="text-center">
            <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-white mt-3" id="loadingText">Memproses data...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ====================== KONSTANTA DAN VARIABEL GLOBAL ======================
        const DENDA_PER_HARI = 5000; // Rp5.000 per hari
        let peminjamanList = JSON.parse(localStorage.getItem('peminjamanBuku')) || [];
        let currentInvoice = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let reportChart = null;
        
        // Inisialisasi Bootstrap components
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        const pengembalianModal = new bootstrap.Modal(document.getElementById('pengembalianModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        // ====================== INISIALISASI ======================
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalPinjam').value = today;
            document.getElementById('modalTanggalKembali').value = today;
            document.getElementById('filterDari').value = getFirstDayOfMonth();
            document.getElementById('filterSampai').value = today;
            document.getElementById('reportDate').value = getCurrentWeek();
            
            // Hitung jatuh tempo saat lama pinjam berubah
            document.getElementById('lamaPinjam').addEventListener('change', hitungJatuhTempo);
            document.getElementById('tanggalPinjam').addEventListener('change', hitungJatuhTempo);
            
            // Load data awal
            updateTabelPengembalian();
            updateTabelRiwayat();
            generateReport();

            // Event listeners
            setupEventListeners();
            
            // Tampilkan notifikasi selamat datang
            showAlert('info', 'Selamat datang di Sistem Peminjaman Buku Perpustakaan');
        });

        // ====================== FUNGSI UTAMA ======================
        function setupEventListeners() {
            // Form peminjaman
            document.getElementById('btnSimpan').addEventListener('click', simpanPeminjaman);

            // Pengembalian buku
            document.getElementById('searchPeminjaman').addEventListener('input', searchPeminjaman);
            document.getElementById('btnPrintInvoice').addEventListener('click', printInvoice);
            document.getElementById('btnCloseInvoice').addEventListener('click', closeInvoice);
            document.getElementById('modalTanggalKembali').addEventListener('change', previewDenda);
            document.getElementById('btnProsesPengembalian').addEventListener('click', prosesPengembalian);
            document.getElementById('btnRefreshPengembalian').addEventListener('click', updateTabelPengembalian);
            document.getElementById('btnConfirmPayment').addEventListener('click', confirmPayment);

            // Riwayat peminjaman
            document.getElementById('searchRiwayat').addEventListener('input', searchRiwayat);
            document.getElementById('btnFilter').addEventListener('click', updateTabelRiwayat);
            document.getElementById('btnPrev').addEventListener('click', prevPage);
            document.getElementById('btnNext').addEventListener('click', nextPage);
            document.getElementById('btnExportRiwayat').addEventListener('click', exportRiwayat);
            document.getElementById('btnRefreshRiwayat').addEventListener('click', refreshRiwayat);

            // Laporan
            document.getElementById('reportType').addEventListener('change', updateReportControls);
            document.getElementById('btnGenerateReport').addEventListener('click', generateReport);
            document.getElementById('btnExportReport').addEventListener('click', exportReport);
            document.getElementById('btnRefreshLaporan').addEventListener('click', refreshLaporan);
        }

        function hitungJatuhTempo() {
            const tglPinjam = document.getElementById('tanggalPinjam').value;
            const lamaPinjam = parseInt(document.getElementById('lamaPinjam').value);
            
            if (tglPinjam && lamaPinjam) {
                const tglPinjamObj = new Date(tglPinjam);
                const tglTempo = new Date(tglPinjamObj);
                tglTempo.setDate(tglPinjamObj.getDate() + (lamaPinjam * 7));
                
                document.getElementById('jatuhTempo').value = formatDate(tglTempo.toISOString().split('T')[0]);
            }
        }

        // ====================== FUNGSI PEMINJAMAN ======================
        function simpanPeminjaman() {
            // Validasi form
            const form = document.getElementById('formPeminjaman');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('error', 'Harap isi semua field yang wajib dengan data yang valid!');
                return;
            }
            
            // Tampilkan loading
            showLoading('Menyimpan data peminjaman...');
            
            // Simulasikan proses async (dalam implementasi nyata bisa AJAX call)
            setTimeout(() => {
                // Ambil nilai dari form
                const nama = document.getElementById('namaPeminjam').value.trim();
                const noHp = document.getElementById('noHp').value.trim();
                const email = document.getElementById('email').value.trim();
                const judul = document.getElementById('judulBuku').value.trim();
                const kodeBuku = document.getElementById('kodeBuku').value.trim();
                const tglPinjam = document.getElementById('tanggalPinjam').value;
                const lama = parseInt(document.getElementById('lamaPinjam').value);

                // Hitung tanggal tempo
                const tglPinjamObj = new Date(tglPinjam);
                const tglTempo = new Date(tglPinjamObj);
                tglTempo.setDate(tglPinjamObj.getDate() + (lama * 7));

                // Buat objek peminjaman baru
                const peminjaman = {
                    id: Date.now(),
                    nama: nama,
                    noHp: noHp,
                    email: email || null,
                    judul: judul,
                    kodeBuku: kodeBuku,
                    tglPinjam: tglPinjam,
                    tglTempo: tglTempo.toISOString().split('T')[0],
                    tglKembali: null,
                    denda: 0,
                    hariTelat: 0,
                    status: 'Dipinjam',
                    invoice: null,
                    createdAt: new Date().toISOString()
                };

                // Tambahkan ke array
                peminjamanList.push(peminjaman);
                
                // Simpan ke localStorage
                saveToLocalStorage();
                
                // Update tampilan
                updateTabelPengembalian();
                updateTabelRiwayat();
                
                // Reset form dan tampilkan notifikasi
                form.reset();
                form.classList.remove('was-validated');
                document.getElementById('tanggalPinjam').value = new Date().toISOString().split('T')[0];
                document.getElementById('jatuhTempo').value = '';
                
                // Sembunyikan loading
                hideLoading();
                
                showAlert('success', 'Peminjaman berhasil disimpan!');
                
                // Scroll ke tabel pengembalian
                document.getElementById('pengembalian-tab').click();
                document.getElementById('pengembalian').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        // ====================== FUNGSI PENGEMBALIAN ======================
        function updateTabelPengembalian() {
            const tbody = document.getElementById('pengembalianBody');
            tbody.innerHTML = '';

            // Filter hanya peminjaman yang belum dikembalikan
            const activePeminjaman = peminjamanList.filter(p => !p.tglKembali);
            
            if (activePeminjaman.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                            <p>Tidak ada data peminjaman aktif</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Urutkan berdasarkan tanggal pinjam (terlama pertama)
            activePeminjaman.sort((a, b) => new Date(a.tglPinjam) - new Date(b.tglPinjam));

            // Isi tabel
            activePeminjaman.forEach((peminjaman, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                
                // Cek status keterlambatan
                const today = new Date();
                const tglTempo = new Date(peminjaman.tglTempo);
                const isLate = today > tglTempo;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${peminjaman.nama}</td>
                    <td>${peminjaman.judul}</td>
                    <td>${peminjaman.kodeBuku}</td>
                    <td>${formatDate(peminjaman.tglPinjam)}</td>
                    <td class="${isLate ? 'text-danger fw-bold' : ''}">
                        ${formatDate(peminjaman.tglTempo)}
                        ${isLate ? '<i class="fas fa-exclamation-circle"></i>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openPengembalianModal(${peminjaman.id})">
                            <i class="fas fa-undo"></i> Proses
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function openPengembalianModal(id) {
            const peminjaman = peminjamanList.find(p => p.id === id);
            if (!peminjaman) return;

            const modalContent = document.getElementById('modalContent');
            
            // Isi konten modal
            modalContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Silahkan masukkan tanggal pengembalian buku untuk menghitung denda.
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <p class="mb-1"><strong>Nama:</strong> ${peminjaman.nama}</p>
                        <p class="mb-1"><strong>No. HP:</strong> ${peminjaman.noHp}</p>
                        ${peminjaman.email ? `<p class="mb-1"><strong>Email:</strong> ${peminjaman.email}</p>` : ''}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <p class="mb-1"><strong>Judul Buku:</strong> ${peminjaman.judul}</p>
                        <p class="mb-1"><strong>Kode Buku:</strong> ${peminjaman.kodeBuku}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p class="mb-1"><strong>Tanggal Pinjam:</strong> ${formatDate(peminjaman.tglPinjam)}</p>
                        <p class="mb-1"><strong>Jatuh Tempo:</strong> ${formatDate(peminjaman.tglTempo)}</p>
                    </div>
                </div>
            `;

            // Set tanggal default pengembalian ke hari ini
            document.getElementById('modalTanggalKembali').value = new Date().toISOString().split('T')[0];
            
            // Reset preview denda
            document.getElementById('dendaPreview').classList.add('d-none');
            
            // Simpan ID peminjaman di atribut modal
            document.getElementById('pengembalianModal').setAttribute('data-peminjaman-id', id);
            
            // Tampilkan modal
            pengembalianModal.show();
        }

        function previewDenda() {
            const modal = document.getElementById('pengembalianModal');
            const id = parseInt(modal.getAttribute('data-peminjaman-id'));
            const tglKembali = document.getElementById('modalTanggalKembali').value;
            
            if (!tglKembali) return;

            const peminjaman = peminjamanList.find(p => p.id === id);
            if (!peminjaman) return;

            const tglKembaliObj = new Date(tglKembali);
            const tglTempoObj = new Date(peminjaman.tglTempo);
            
            let hariTelat = 0;
            let denda = 0;
            
            if (tglKembaliObj > tglTempoObj) {
                const diffTime = tglKembaliObj - tglTempoObj;
                hariTelat = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                denda = hariTelat * DENDA_PER_HARI;
            }
            
            // Tampilkan preview
            const previewElement = document.getElementById('dendaPreview');
            document.getElementById('previewTelat').textContent = `${hariTelat} hari`;
            document.getElementById('previewDenda').textContent = formatCurrency(denda);
            previewElement.classList.remove('d-none');
        }

        function prosesPengembalian() {
            const modal = document.getElementById('pengembalianModal');
            const id = parseInt(modal.getAttribute('data-peminjaman-id'));
            const tglKembali = document.getElementById('modalTanggalKembali').value;
            
            if (!tglKembali) {
                showAlert('error', 'Harap masukkan tanggal kembali!');
                return;
            }

            const peminjaman = peminjamanList.find(p => p.id === id);
            if (!peminjaman) return;

            const tglKembaliObj = new Date(tglKembali);
            const tglTempoObj = new Date(peminjaman.tglTempo);
            
            let hariTelat = 0;
            let denda = 0;
            
            if (tglKembaliObj > tglTempoObj) {
                const diffTime = tglKembaliObj - tglTempoObj;
                hariTelat = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                denda = hariTelat * DENDA_PER_HARI;
            }
            
            // Update data peminjaman
            peminjaman.tglKembali = tglKembali;
            peminjaman.denda = denda;
            peminjaman.hariTelat = hariTelat;
            peminjaman.status = 'Dikembalikan';
            
            // Generate nomor invoice jika ada denda
            if (denda > 0) {
                const invoiceCount = peminjamanList.filter(p => p.invoice).length + 1;
                const invoiceNumber = `INV-${new Date().getFullYear()}-${invoiceCount.toString().padStart(3, '0')}`;
                peminjaman.invoice = invoiceNumber;
                
                // Tampilkan invoice
                showInvoice(peminjaman);
            }
            
            // Simpan ke localStorage
            saveToLocalStorage();
            
            // Update tampilan
            updateTabelPengembalian();
            updateTabelRiwayat();
            pengembalianModal.hide();
            
            // Tampilkan notifikasi
            if (denda > 0) {
                showAlert('warning', `Buku berhasil dikembalikan dengan denda ${formatCurrency(denda)} (terlambat ${hariTelat} hari)`);
            } else {
                showAlert('success', 'Buku berhasil dikembalikan tepat waktu!');
            }
        }

        function confirmPayment() {
            if (!currentInvoice) return;
            
            // Tampilkan modal konfirmasi
            document.getElementById('confirmModalTitle').textContent = 'Konfirmasi Pembayaran';
            document.getElementById('confirmModalBody').innerHTML = `
                <p>Apakah Anda yakin ingin mengkonfirmasi pembayaran untuk invoice <strong>${currentInvoice.invoice}</strong>?</p>
                <p>Total pembayaran: <strong class="text-danger">${formatCurrency(currentInvoice.denda)}</strong></p>
            `;
            
            // Setel fungsi untuk tombol konfirmasi
            const confirmBtn = document.getElementById('confirmModalButton');
            confirmBtn.onclick = function() {
                // Update status pembayaran
                const peminjaman = peminjamanList.find(p => p.id === currentInvoice.id);
                if (peminjaman) {
                    peminjaman.status = 'Lunas';
                    saveToLocalStorage();
                    updateTabelRiwayat();
                    
                    // Tutup modal dan invoice
                    confirmModal.hide();
                    closeInvoice();
                    
                    showAlert('success', 'Pembayaran berhasil dikonfirmasi!');
                }
            };
            
            confirmModal.show();
        }

        function showInvoice(peminjaman) {
            currentInvoice = peminjaman;
            
            // Isi data invoice
            document.getElementById('invoiceNumber').textContent = peminjaman.invoice;
            document.getElementById('invoiceDate').textContent = formatDate(new Date().toISOString());
            document.getElementById('invoiceNama').textContent = peminjaman.nama;
            document.getElementById('invoiceHp').textContent = peminjaman.noHp;
            document.getElementById('invoiceEmail').textContent = peminjaman.email || '-';
            document.getElementById('invoiceJudul').textContent = peminjaman.judul;
            document.getElementById('invoiceKode').textContent = peminjaman.kodeBuku;
            
            // Detail keterlambatan
            document.getElementById('detailPinjam').textContent = formatDate(peminjaman.tglPinjam);
            document.getElementById('detailTempo').textContent = formatDate(peminjaman.tglTempo);
            document.getElementById('detailKembali').textContent = formatDate(peminjaman.tglKembali);
            document.getElementById('detailTelat').textContent = `${peminjaman.hariTelat} hari`;
            
            // Item invoice
            const invoiceItems = document.getElementById('invoiceItems');
            
            if (peminjaman.denda > 0) {
                invoiceItems.innerHTML = `
                    <tr>
                        <td>Denda keterlambatan (${peminjaman.hariTelat} hari @ Rp5.000)</td>
                        <td>${peminjaman.hariTelat}</td>
                        <td>${formatCurrency(DENDA_PER_HARI)}</td>
                        <td>${formatCurrency(peminjaman.denda)}</td>
                    </tr>
                `;
            } else {
                invoiceItems.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">Tidak ada denda</td>
                    </tr>
                `;
            }
            
            // Total denda
            document.getElementById('invoiceTotal').textContent = formatCurrency(peminjaman.denda);
            
            // Tampilkan/sembunyikan tombol konfirmasi pembayaran
            const confirmBtn = document.getElementById('btnConfirmPayment');
            if (peminjaman.status === 'Dikembalikan' && peminjaman.denda > 0) {
                confirmBtn.style.display = 'block';
            } else {
                confirmBtn.style.display = 'none';
            }
            
            // Tampilkan invoice section
            document.getElementById('invoiceSection').style.display = 'block';
            
            // Scroll ke invoice
            document.getElementById('invoiceSection').scrollIntoView({ behavior: 'smooth' });
        }

        function closeInvoice() {
            document.getElementById('invoiceSection').style.display = 'none';
            currentInvoice = null;
        }

        function printInvoice() {
            if (!currentInvoice) return;

            const printContent = document.getElementById('invoiceSection').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Setel ulang tampilan setelah mencetak
            updateTabelPengembalian();
            updateTabelRiwayat();
            document.getElementById('invoiceSection').style.display = 'block';
        }

        function searchPeminjaman() {
            const input = document.getElementById('searchPeminjaman');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('tabelPengembalian');
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName('td');
                
                for (let j = 1; j < td.length - 1; j++) { // Skip kolom nomor dan aksi
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // ====================== FUNGSI RIWAYAT ======================
        function updateTabelRiwayat() {
            const tbody = document.getElementById('riwayatBody');
            tbody.innerHTML = '';
            
            // Ambil filter tanggal
            const dari = document.getElementById('filterDari').value;
            const sampai = document.getElementById('filterSampai').value;
            
            // Filter data berdasarkan tanggal
            let filteredData = peminjamanList.filter(p => {
                const tglPinjam = new Date(p.tglPinjam);
                const dariDate = new Date(dari);
                const sampaiDate = new Date(sampai);
                
                return tglPinjam >= dariDate && tglPinjam <= sampaiDate;
            });
            
            // Filter berdasarkan pencarian jika ada
            const searchTerm = document.getElementById('searchRiwayat').value.toUpperCase();
            if (searchTerm) {
                filteredData = filteredData.filter(p => 
                    p.nama.toUpperCase().includes(searchTerm) || 
                    p.judul.toUpperCase().includes(searchTerm) || 
                    p.kodeBuku.toUpperCase().includes(searchTerm)
                );
            }
            
            // Hitung total data dan denda
            const totalData = filteredData.length;
            const totalDenda = filteredData.reduce((sum, p) => sum + p.denda, 0);
            
            document.getElementById('totalData').textContent = totalData;
            document.getElementById('totalDenda').textContent = formatCurrency(totalDenda);
            
            if (totalData === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-book-open fa-2x mb-3 text-muted"></i>
                            <p>Tidak ada data yang ditemukan</p>
                        </td>
                    </tr>
                `;
                updatePaginationControls(0);
                return;
            }
            
            // Urutkan berdasarkan tanggal pinjam (terbaru pertama)
            filteredData.sort((a, b) => new Date(b.tglPinjam) - new Date(a.tglPinjam));
            
            // Pagination
            const totalPages = Math.ceil(totalData / itemsPerPage);
            updatePaginationControls(totalPages);
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);
            
            // Isi tabel
            paginatedData.forEach((peminjaman, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                const noUrut = startIndex + index + 1;
                
                row.innerHTML = `
                    <td>${noUrut}</td>
                    <td>${peminjaman.nama}</td>
                    <td>${peminjaman.judul}</td>
                    <td>${peminjaman.kodeBuku}</td>
                    <td>${formatDate(peminjaman.tglPinjam)}</td>
                    <td>${formatDate(peminjaman.tglTempo)}</td>
                    <td>${peminjaman.tglKembali ? formatDate(peminjaman.tglKembali) : '-'}</td>
                    <td class="${peminjaman.hariTelat > 0 ? 'text-danger' : ''}">
                        ${peminjaman.hariTelat > 0 ? `${peminjaman.hariTelat} hari` : '-'}
                    </td>
                    <td class="${peminjaman.denda > 0 ? 'text-danger fw-bold' : ''}">
                        ${peminjaman.denda > 0 ? formatCurrency(peminjaman.denda) : '-'}
                    </td>
                    <td>
                        <span class="status-badge ${getStatusBadgeClass(peminjaman.status)}">
                            ${peminjaman.status}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Dipinjam': return 'badge-warning';
                case 'Dikembalikan': return 'badge-primary';
                case 'Lunas': return 'badge-success';
                default: return 'badge-secondary';
            }
        }

        function searchRiwayat() {
            currentPage = 1;
            updateTabelRiwayat();
        }

        function refreshRiwayat() {
            currentPage = 1;
            document.getElementById('searchRiwayat').value = '';
            document.getElementById('filterDari').value = getFirstDayOfMonth();
            document.getElementById('filterSampai').value = new Date().toISOString().split('T')[0];
            updateTabelRiwayat();
            showAlert('success', 'Data riwayat telah diperbarui');
        }

        function exportRiwayat() {
            showLoading('Mempersiapkan data untuk diexport...');
            
            // Simulasikan proses export
            setTimeout(() => {
                hideLoading();
                showAlert('success', 'Data riwayat berhasil diexport (simulasi)');
            }, 1500);
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTabelRiwayat();
            }
        }

        function nextPage() {
            const totalData = peminjamanList.length;
            const totalPages = Math.ceil(totalData / itemsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                updateTabelRiwayat();
            }
        }

        function updatePaginationControls(totalPages) {
            const pageInfo = document.getElementById('pageInfo');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            
            if (totalPages === 0) {
                pageInfo.textContent = 'Tidak ada data';
                btnPrev.disabled = true;
                btnNext.disabled = true;
                return;
            }
            
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages;
        }

        // ====================== FUNGSI LAPORAN ======================
        function updateReportControls() {
            const reportType = document.getElementById('reportType').value;
            const dateRangeControls = document.getElementById('dateRangeControls');
            
            switch (reportType) {
                case 'mingguan':
                    dateRangeControls.innerHTML = `
                        <label class="form-label">Pilih Minggu</label>
                        <input type="week" class="form-control" id="reportDate">
                    `;
                    break;
                case 'bulanan':
                    dateRangeControls.innerHTML = `
                        <label class="form-label">Pilih Bulan</label>
                        <input type="month" class="form-control" id="reportDate">
                    `;
                    break;
                case 'tahunan':
                    dateRangeControls.innerHTML = `
                        <label class="form-label">Pilih Tahun</label>
                        <input type="number" class="form-control" id="reportDate" min="2000" max="2099" step="1" value="${new Date().getFullYear()}">
                    `;
                    break;
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            let startDate, endDate;
            
            switch (reportType) {
                case 'mingguan':
                    // Parse input week (format: YYYY-Www)
                    const [year, week] = reportDate.split('-W').map(Number);
                    startDate = getDateOfWeek(week, year);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                    
                case 'bulanan':
                    // Parse input month (format: YYYY-MM)
                    const [yearMonth, month] = reportDate.split('-').map(Number);
                    startDate = new Date(yearMonth, month - 1, 1);
                    endDate = new Date(yearMonth, month, 0); // Last day of month
                    break;
                    
                case 'tahunan':
                    const selectedYear = parseInt(reportDate);
                    startDate = new Date(year, 0, 1);
                    endDate = new Date(year, 11, 31);
                    break;
            }
            
            // Filter data berdasarkan periode
            const filteredData = peminjamanList.filter(p => {
                const tglPinjam = new Date(p.tglPinjam);
                return tglPinjam >= startDate && tglPinjam <= endDate;
            });
            
            // Hitung statistik
            const totalPeminjaman = filteredData.length;
            const tepatWaktu = filteredData.filter(p => p.tglKembali && p.hariTelat === 0).length;
            const terlambat = filteredData.filter(p => p.tglKembali && p.hariTelat > 0).length;
            const totalDenda = filteredData.reduce((sum, p) => sum + p.denda, 0);
            
            // Update summary cards
            document.getElementById('totalPeminjaman').textContent = totalPeminjaman;
            document.getElementById('tepatWaktu').textContent = tepatWaktu;
            document.getElementById('terlambat').textContent = terlambat;
            document.getElementById('reportDenda').textContent = formatCurrency(totalDenda);
            
            // Siapkan data untuk chart dan tabel
            prepareChartData(filteredData, reportType, startDate, endDate);
            prepareReportTable(filteredData, reportType);
            
            showAlert('success', `Laporan ${reportType} berhasil digenerate`);
        }

        function refreshLaporan() {
            document.getElementById('reportType').value = 'mingguan';
            document.getElementById('reportDate').value = getCurrentWeek();
            generateReport();
        }

        function prepareChartData(data, reportType, startDate, endDate) {
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            // Hapus chart sebelumnya jika ada
            if (reportChart) {
                reportChart.destroy();
            }
            
            let labels = [];
            let dataTepatWaktu = [];
            let dataTerlambat = [];
            
            // Buat label dan data berdasarkan jenis laporan
            switch (reportType) {
                case 'mingguan':
                    // Untuk mingguan, kita tampilkan per hari
                    labels = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    
                    // Inisialisasi array dengan 0
                    dataTepatWaktu = new Array(7).fill(0);
                    dataTerlambat = new Array(7).fill(0);
                    
                    // Hitung data per hari
                    data.forEach(p => {
                        const tglPinjam = new Date(p.tglPinjam);
                        const dayOfWeek = tglPinjam.getDay(); // 0=Minggu, 1=Senin, ..., 6=Sabtu
                        
                        if (p.tglKembali) {
                            if (p.hariTelat > 0) {
                                dataTerlambat[dayOfWeek]++;
                            } else {
                                dataTepatWaktu[dayOfWeek]++;
                            }
                        }
                    });
                    break;
                    
                case 'bulanan':
                    // Untuk bulanan, kita tampilkan per minggu
                    const weeksInMonth = Math.ceil((endDate.getDate() + startDate.getDay()) / 7);
                    
                    for (let i = 1; i <= weeksInMonth; i++) {
                        labels.push(`Minggu ${i}`);
                    }
                    
                    // Inisialisasi array
                    dataTepatWaktu = new Array(weeksInMonth).fill(0);
                    dataTerlambat = new Array(weeksInMonth).fill(0);
                    
                    // Hitung data per minggu
                    data.forEach(p => {
                        const tglPinjam = new Date(p.tglPinjam);
                        const weekOfMonth = Math.ceil((tglPinjam.getDate() + startDate.getDay()) / 7) - 1;
                        
                        if (p.tglKembali) {
                            if (p.hariTelat > 0) {
                                dataTerlambat[weekOfMonth]++;
                            } else {
                                dataTepatWaktu[weekOfMonth]++;
                            }
                        }
                    });
                    break;
                    
                case 'tahunan':
                    // Untuk tahunan, kita tampilkan per bulan
                    labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
                    
                    // Inisialisasi array
                    dataTepatWaktu = new Array(12).fill(0);
                    dataTerlambat = new Array(12).fill(0);
                    
                    // Hitung data per bulan
                    data.forEach(p => {
                        const tglPinjam = new Date(p.tglPinjam);
                        const month = tglPinjam.getMonth(); // 0-11
                        
                        if (p.tglKembali) {
                            if (p.hariTelat > 0) {
                                dataTerlambat[month]++;
                            } else {
                                dataTepatWaktu[month]++;
                            }
                        }
                    });
                    break;
            }
            
            // Buat chart baru
            reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tepat Waktu',
                            data: dataTepatWaktu,
                            backgroundColor: '#2ecc71',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        },
                        {
                            label: 'Terlambat',
                            data: dataTerlambat,
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Peminjaman'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: reportType === 'mingguan' ? 'Hari dalam Minggu' : 
                                      reportType === 'bulanan' ? 'Minggu dalam Bulan' : 'Bulan dalam Tahun'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Statistik Peminjaman ${getReportTitle(reportType)}`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function prepareReportTable(data, reportType) {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';
            
            let groupedData = {};
            
            // Kelompokkan data berdasarkan periode
            data.forEach(p => {
                const tglPinjam = new Date(p.tglPinjam);
                let key;
                
                switch (reportType) {
                    case 'mingguan':
                        key = formatDate(p.tglPinjam);
                        break;
                    case 'bulanan':
                        key = `Minggu ${Math.ceil(tglPinjam.getDate() / 7)}`;
                        break;
                    case 'tahunan':
                        key = tglPinjam.toLocaleString('id-ID', { month: 'long' });
                        break;
                }
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        jumlah: 0,
                        tepatWaktu: 0,
                        terlambat: 0,
                        denda: 0
                    };
                }
                
                groupedData[key].jumlah++;
                
                if (p.tglKembali) {
                    if (p.hariTelat > 0) {
                        groupedData[key].terlambat++;
                        groupedData[key].denda += p.denda;
                    } else {
                        groupedData[key].tepatWaktu++;
                    }
                }
            });
            
            // Urutkan data berdasarkan periode
            const sortedKeys = Object.keys(groupedData).sort((a, b) => {
                if (reportType === 'mingguan') {
                    return new Date(a) - new Date(b);
                } else if (reportType === 'bulanan') {
                    return parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]);
                } else { // tahunan
                    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    return months.indexOf(a) - months.indexOf(b);
                }
            });
            
            // Isi tabel
            sortedKeys.forEach((key, index) => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                const item = groupedData[key];
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${key}</td>
                    <td>${item.jumlah}</td>
                    <td>${item.tepatWaktu}</td>
                    <td>${item.terlambat}</td>
                    <td>${formatCurrency(item.denda)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function exportReport() {
            showLoading('Mempersiapkan laporan untuk diexport...');
            
            // Simulasikan proses export
            setTimeout(() => {
                hideLoading();
                showAlert('success', 'Laporan berhasil diexport (simulasi)');
            }, 1500);
        }

        // ====================== FUNGSI UTILITAS ======================
        function saveToLocalStorage() {
            localStorage.setItem('peminjamanBuku', JSON.stringify(peminjamanList));
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                weekday: 'short',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatCurrency(amount) {
            return 'Rp' + amount.toLocaleString('id-ID');
        }

        function showAlert(type, message) {
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastTime = document.getElementById('toastTime');
            
            // Set warna berdasarkan jenis alert
            let bgColor = '';
            switch (type) {
                case 'success':
                    bgColor = 'bg-success';
                    toastTitle.textContent = 'Sukses';
                    break;
                case 'error':
                    bgColor = 'bg-danger';
                    toastTitle.textContent = 'Error';
                    break;
                case 'warning':
                    bgColor = 'bg-warning';
                    toastTitle.textContent = 'Peringatan';
                    break;
                case 'info':
                    bgColor = 'bg-info';
                    toastTitle.textContent = 'Informasi';
                    break;
                default:
                    bgColor = 'bg-primary';
                    toastTitle.textContent = 'Notifikasi';
            }
            
            // Update toast classes
            const toastHeader = toastEl.querySelector('.toast-header');
            toastHeader.className = 'toast-header ' + bgColor + ' text-white';
            
            // Set waktu
            const now = new Date();
            toastTime.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            // Set pesan
            toastMessage.textContent = message;
            
            // Tampilkan toast
            toast.show();
        }

        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function getFirstDayOfMonth() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        }

        function getCurrentWeek() {
            const date = new Date();
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return date.getFullYear() + '-W' + 
                   Math.round(((date - week1) / 86400000 + week1.getDay() + 1) / 7).toString().padStart(2, '0');
        }

        function getDateOfWeek(week, year) {
            const date = new Date(year, 0, 1 + (week - 1) * 7);
            const dayOfWeek = date.getDay();
            const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }

        function getReportTitle(reportType) {
            const reportDate = document.getElementById('reportDate').value;
            
            switch (reportType) {
                case 'mingguan':
                    return `Minggu ${reportDate.split('-W')[1]} Tahun ${reportDate.split('-')[0]}`;
                case 'bulanan':
                    const [year, month] = reportDate.split('-');
                    return new Date(year, month - 1, 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                case 'tahunan':
                    return `Tahun ${reportDate}`;
            }
        }
    </script>
</body>
</html>